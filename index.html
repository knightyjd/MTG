<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Collection Manager (Multi-User)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'mtg-w': '#f8f8f8',
                        'mtg-u': '#90c3e7',
                        'mtg-b': '#323232',
                        'mtg-r': '#e89e6a',
                        'mtg-g': '#90cc90',
                        'mtg-bg': '#0f172a',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            /* Using relative path for image in the same folder */
            background-image: url('mtg-art.jpg'); 
            background-size: cover; 
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* Dark Overlay for Text Readability */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); 
            z-index: -1;
        }
        
        /* Basic styling for the table row based on color */
        .color-w { background-color: #f8f8f8; color: #1e293b; }
        .color-u { background-color: #90c3e7; color: #1e293b; }
        .color-b { background-color: #323232; color: #f8ff8f8; }
        .color-r { background-color: #e89e6a; color: #1e293b; }
        .color-g { background-color: #90cc90; color: #1e293b; }
        .color-m { background-color: #c0c0c0; color: #1e293b; } /* Multi/Colorless */

        /* Custom scrollbar */
        .card-container::-webkit-scrollbar { width: 8px; }
        .card-container::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-5xl sm:text-6xl font-extrabold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-red-400 to-orange-400">
                Jim's Magic Collection
            </h1>
            <p class="text-gray-300 text-lg font-semibold">
                Total Cards in Your Private Collection: <span id="totalCardCount" class="text-orange-300">0</span>
            </p>
        </header>
        
        <!-- Main Content Area: Two-Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Control Panel (Add, Filter, Image Display) - Column 1 -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- NEW: Add Card Section -->
                <div id="addCardSection" class="bg-black/60 backdrop-blur-sm p-6 rounded-2xl shadow-2xl border border-red-700/50">
                    <h2 class="text-xl font-semibold text-white mb-4">1. Add New Card</h2>
                    <form id="addCardForm" class="space-y-3">
                        <input type="text" id="newCardName" placeholder="Card Name (Required)" required
                            class="p-3 w-full rounded-lg bg-slate-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-orange-500 border-transparent">
                        
                        <input type="text" id="newCardColor" placeholder="Color (e.g., Blue, Green/Red)" required
                            class="p-3 w-full rounded-lg bg-slate-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-orange-500 border-transparent">
                        
                        <input type="text" id="newCardAbility" placeholder="Abilities"
                            class="p-3 w-full rounded-lg bg-slate-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-orange-500 border-transparent">
                        
                        <input type="url" id="newCardImage" placeholder="Image URL (Scryfall links work best)"
                            class="p-3 w-full rounded-lg bg-slate-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-orange-500 border-transparent">
                        
                        <button type="submit" 
                            class="w-full p-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition duration-200">
                            Save Card to Collection
                        </button>
                    </form>
                </div>

                <!-- Filter Section -->
                <div id="filterSection" class="bg-black/60 backdrop-blur-sm p-6 rounded-2xl shadow-2xl border border-red-700/50">
                    <h2 class="text-xl font-semibold text-white mb-4">2. Filter Cards</h2>
                    <div class="space-y-4">
                        <input type="text" id="filterName" placeholder="Search Card Name..."
                            class="p-3 w-full rounded-lg bg-slate-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-orange-500 focus:border-transparent border-transparent"
                            oninput="filterCards()">
                        
                        <select id="filterColor" onchange="filterCards()"
                            class="p-3 w-full rounded-lg bg-slate-700 text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent border-transparent">
                            <option value="">All Mana Colors</option>
                            <option value="W" class="text-black">White (W)</option>
                            <option value="U" class="text-black">Blue (U)</option>
                            <option value="B" class="text-white">Black (B)</option>
                            <option value="R" class="text-black">Red (R)</option>
                            <option value="G" class="text-black">Green (G)</option>
                            <option value="M">Multi / Colorless (M)</option>
                        </select>

                        <input type="text" id="filterAbility" placeholder="Search Ability (e.g., Flying)..."
                            class="p-3 w-full rounded-lg bg-slate-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-orange-500 focus:border-transparent border-transparent"
                            oninput="filterCards()">
                    </div>
                </div>
                
                <!-- Card Image Display Section -->
                <div id="imageDisplaySection" class="bg-black/60 backdrop-blur-sm p-6 rounded-2xl shadow-2xl border border-red-700/50">
                    <h2 id="selectedCardName" class="text-xl font-semibold text-white mb-4 text-center truncate">Select a Card</h2>
                    <div class="flex justify-center">
                         <!-- Placeholder image size is standard MTG card ratio (223x310) -->
                        <img id="cardImage" src="https://placehold.co/223x310/1f2937/9ca3af?text=Select%20a%20Card" 
                             alt="Selected Card Image" class="rounded-xl shadow-2xl max-w-full h-auto">
                    </div>
                </div>
            </div>

            <!-- Results Table (Main Content) - Column 2 -->
            <div class="lg:col-span-2 bg-black/60 backdrop-blur-sm p-6 rounded-2xl shadow-2xl border border-red-700/50 overflow-hidden">
                <h2 class="text-xl font-semibold text-white mb-4">3. Your Collection (<span id="resultCount">0</span> Cards)</h2>
                <div id="cardTableContainer" class="overflow-y-auto card-container max-h-[70vh] rounded-xl border border-slate-700">
                    <table class="min-w-full divide-y divide-slate-700">
                        <!-- Table Header: UPDATED Background and Text Color -->
                        <thead class="bg-red-900/50 sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-red-200 uppercase tracking-wider rounded-tl-xl">
                                    Card Name
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-red-200 uppercase tracking-wider">
                                    Color
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-red-200 uppercase tracking-wider rounded-tr-xl">
                                    Abilities
                                </th>
                            </tr>
                        </thead>
                        <tbody id="cardList" class="divide-y divide-slate-700">
                            <!-- Card data will be injected here -->
                        </tbody>
                    </table>
                </div>
                <p id="noResults" class="text-center text-gray-400 py-6 hidden">No cards match your current filters.</p>
            </div>
            
        </div>
        
        <!-- User ID Display for Multi-User Environment -->
        <footer class="mt-8 text-center text-xs text-gray-500">
            <p>
                <span id="authStatus" class="text-yellow-400">Initializing...</span> | 
                Your unique User ID: <span id="currentUserId" class="font-mono text-gray-300 truncate">N/A</span>
            </p>
        </footer>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables are provided by the Canvas environment.
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- START: CONFIGURATION FOR GITHUB DEPLOYMENT ---
        /**
         * Function to safely retrieve Firebase configuration.
         * When running on Canvas, it uses the provided config.
         * When running on GitHub Pages, it uses the hardcoded config below.
         */
        function getFirebaseConfig() {
            // 1. Prioritize configuration provided by the Canvas environment
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                return JSON.parse(__firebase_config);
            }
            
            // 2. Fallback for external hosting (GitHub Pages). 
            // !!! IMPORTANT: You MUST replace the dummy values below with your actual Firebase project config.
            // Find this config in your Firebase project console under Project Settings > General.
            console.warn("ATTENTION: Using placeholder Firebase config. Replace the values below for successful GitHub deployment!");
            return {
                apiKey: "AIzaSyDDO2IWkIyaT4Vme-JimTXaWy3gbtwLiUQ", 
                authDomain: "mtgcards-5b2be.firebaseapp.com",
                projectId: "mtgcards-5b2be",
                sstorageBucket: "mtgcards-5b2be.firebasestorage.app",
                messagingSenderId: "403373169025",
                appId: "1:403373169025:web:20096786631eb8dfd33080",
            };
        }

        const firebaseConfig = getFirebaseConfig();
        // Use environment App ID or fallback to the project ID from the config
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId || 'default-app-id'; 
        // --- END: CONFIGURATION FOR GITHUB DEPLOYMENT ---


        setLogLevel('debug'); // Enable Firestore logging

        let db = null;
        let auth = null;
        let userId = null;
        let allCardData = []; // Array to hold the current user's collection data from Firestore

        /**
         * Converts color string to a normalized single-letter code for filtering.
         * @param {string} colorString - The descriptive color (e.g., 'Blue', 'Green/Red').
         * @returns {string} - The normalized code ('W', 'U', 'B', 'R', 'G', or 'M').
         */
        function normalizeColor(colorString) {
            if (!colorString) return 'M';
            const upper = colorString.toUpperCase();
            
            // Single color check
            if (upper.length === 1 && 'WUBRG'.includes(upper)) {
                return upper;
            }
            
            // Multi-color check (if it contains multiple color codes or is colorless)
            let colorCodes = upper.match(/[WUBRG]/g);
            if (colorCodes && colorCodes.length > 1) {
                return 'M';
            }
            
            // Check for explicit multi-color text (like "Green/Blue")
            if (upper.includes('/') || upper.includes('COLORLESS') || upper.includes('MULTI')) {
                 return 'M';
            }

            // Fallback for single color names (e.g., 'BLUE')
            if (upper.includes('WHITE')) return 'W';
            if (upper.includes('BLUE')) return 'U';
            if (upper.includes('BLACK')) return 'B';
            if (upper.includes('RED')) return 'R';
            if (upper.includes('GREEN')) return 'G';
            
            return 'M';
        }

        /**
         * Initializes Firebase services and authenticates the user.
         */
        async function initializeFirebase() {
            try {
                // Check if the configuration has been replaced for external hosting
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                     // Only warn if we are outside the Canvas environment and using placeholders
                     if (typeof __firebase_config === 'undefined') {
                        document.getElementById('authStatus').textContent = 'CONFIG MISSING! Check console.';
                        console.error("External Hosting Error: You must replace the YOUR_... placeholders in the getFirebaseConfig function.");
                        return;
                     }
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const statusEl = document.getElementById('authStatus');
                statusEl.textContent = 'Authenticating...';

                // Sign in using the custom token (Canvas) or anonymously (GitHub/External)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('currentUserId').textContent = userId;
                        statusEl.textContent = 'Authenticated';
                        listenForCollectionUpdates();
                    } else {
                        userId = null;
                        document.getElementById('currentUserId').textContent = 'N/A';
                        statusEl.textContent = 'Signed Out';
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                document.getElementById('authStatus').textContent = 'Auth Failed';
            }
        }

        /**
         * Sets up a real-time listener for the user's private MTG collection in Firestore.
         */
        function listenForCollectionUpdates() {
            if (!db || !userId) {
                console.warn("Firestore or User ID is not ready.");
                return;
            }

            // Path ensures data is private to this user and this app ID
            const collectionPath = `artifacts/${appId}/users/${userId}/mtg_collection`;
            const userRef = collection(db, collectionPath);
            const q = query(userRef);

            // Set up real-time listener
            onSnapshot(q, (snapshot) => {
                const newCardData = [];
                snapshot.forEach(doc => {
                    newCardData.push({ id: doc.id, ...doc.data() });
                });
                
                allCardData = newCardData;
                updateTotalCountDisplay(allCardData.length);
                filterCards(); // Re-render the list with the latest data
            }, (error) => {
                console.error("Error fetching collection data:", error);
            });
        }

        /**
         * Adds a new card to the user's Firestore collection.
         */
        document.getElementById('addCardForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db || !userId) {
                console.warn("Cannot save: User is not authenticated.");
                return;
            }

            const name = document.getElementById('newCardName').value.trim();
            const color = document.getElementById('newCardColor').value.trim();
            const abilities = document.getElementById('newCardAbility').value.trim();
            const imageUrl = document.getElementById('newCardImage').value.trim();

            if (!name || !color) {
                console.error("Card Name and Color are required.");
                return;
            }

            const newCard = {
                name: name,
                color: color,
                abilities: abilities || 'None',
                imageUrl: imageUrl || 'https://placehold.co/223x310/1f2937/9ca3af?text=No%20Image',
                normalizedColor: normalizeColor(color),
                timestamp: Date.now() 
            };
            
            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/mtg_collection`;
                await addDoc(collection(db, collectionPath), newCard);
                e.target.reset(); // Clear form on success
                document.getElementById('newCardName').focus();

            } catch (error) {
                console.error("Error adding card to Firestore:", error);
            }
        });


        // --- UI AND FILTERING LOGIC (Mostly Unchanged) ---

        function updateTotalCountDisplay(count) {
            const totalCountEl = document.getElementById('totalCardCount');
            if (totalCountEl) {
                totalCountEl.textContent = count;
            }
        }
        
        function displayCardImage(card) {
            const imageEl = document.getElementById('cardImage');
            const nameEl = document.getElementById('selectedCardName');
            const placeholderSrc = 'https://placehold.co/223x310/1f2937/9ca3af?text=Select%20a%20Card';

            if (card && card.imageUrl) {
                imageEl.src = card.imageUrl;
                imageEl.onerror = () => imageEl.src = placeholderSrc; 
                nameEl.textContent = card.name;
            } else {
                imageEl.src = placeholderSrc;
                nameEl.textContent = 'Select a Card';
            }
        }

        function filterCards() {
            const nameFilter = document.getElementById('filterName').value.toLowerCase();
            const colorFilter = document.getElementById('filterColor').value.toUpperCase();
            const abilityFilter = document.getElementById('filterAbility').value.toLowerCase();

            const filteredData = allCardData.filter(card => {
                let matches = true;

                if (nameFilter && !card.name.toLowerCase().includes(nameFilter)) {
                    matches = false;
                }

                // Check against the normalized color key stored in Firestore
                if (colorFilter && colorFilter !== card.normalizedColor) {
                    matches = false;
                }
                
                if (abilityFilter && !card.abilities.toLowerCase().includes(abilityFilter)) {
                    matches = false;
                }

                return matches;
            });

            renderTable(filteredData);
            
            if (filteredData.length > 0) {
                displayCardImage(filteredData[0]);
            } else {
                displayCardImage(null);
            }
        }

        function renderTable(data) {
            const listEl = document.getElementById('cardList');
            const resultCountEl = document.getElementById('resultCount');
            const noResultsEl = document.getElementById('noResults');
            
            listEl.innerHTML = '';
            resultCountEl.textContent = data.length;

            if (data.length === 0) {
                noResultsEl.classList.remove('hidden');
                return;
            }

            noResultsEl.classList.add('hidden');
            
            data.forEach(card => {
                const colorClass = `color-${card.normalizedColor.toLowerCase()}`;
                
                const row = document.createElement('tr');
                row.className = `transition duration-150 ease-in-out hover:bg-slate-700/70 text-sm cursor-pointer ${colorClass}`;
                row.onclick = () => displayCardImage(card);
                
                // Card Name Cell
                const nameCell = document.createElement('td');
                nameCell.className = 'px-4 py-3 font-medium';
                nameCell.textContent = card.name;
                row.appendChild(nameCell);

                // Mana Colour Cell
                const colorCell = document.createElement('td');
                colorCell.className = 'px-4 py-3 uppercase font-bold';
                colorCell.textContent = card.color;
                row.appendChild(colorCell);

                // Abilities Cell
                const abilitiesCell = document.createElement('td');
                abilitiesCell.className = 'px-4 py-3';
                abilitiesCell.textContent = card.abilities;
                row.appendChild(abilitiesCell);

                listEl.appendChild(row);
            });
        }
        
        // Start the application by initializing Firebase
        initializeFirebase(); 
    </script>
</body>
</html>
